<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LEVER MASTER">
    <meta name="theme-color" content="#00f5ff">
    <meta name="description" content="てこの原理を学ぶ物理学習ゲーム - LEVER MASTER">

    <!-- PWA Manifest -->
    <link rel="manifest" href="public/manifest.json">

    <!-- Icons -->
    <link rel="apple-touch-icon" href="public/icons/apple-touch-icon.png">
    <link rel="icon" type="image/svg+xml" href="public/icons/icon.svg">
    <link rel="icon" type="image/png" sizes="192x192" href="public/icons/icon-192.png">

    <title>LEVER MASTER</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap"
        rel="stylesheet">

    <!-- App Styles -->
    <link rel="stylesheet" href="src/css/styles.css">
</head>


<body>
    <!-- タップして開始スプラッシュ画面 -->
    <div class="splash-screen" id="splash-screen" onclick="dismissSplash(event)" ontouchstart="dismissSplash(event)">
        <div class="splash-content">
            <div class="splash-title">LEVER MASTER</div>
            <div class="splash-subtitle">てこマスター</div>
            <div class="splash-tap">
                <div class="splash-tap-icon">👆</div>
                <div class="splash-tap-text">TAP TO START</div>
            </div>
            <div class="splash-hint">タップして始めよう</div>
        </div>
    </div>

    <!-- スマホ縦画面ブロック -->
    <div class="device-overlay" id="device-overlay">📱↻ 横向きにしてね</div>

    <div class="cyber-bg"></div>
    <div class="grid-overlay"></div>
    <div class="particle-container" id="particles"></div>
    <div class="screen-flash" id="screen-flash"></div>
    <div class="combo-text" id="combo-text"></div>

    <div class="drag-indicator" id="drag-indicator">
        <div class="drag-text" id="drag-text">DRAGGING...</div>
        <div class="drag-circle"></div>
    </div>

    <!-- スタートプレイヤー選択ルーレット -->
    <div class="start-roulette-overlay hidden" id="roulette-overlay">
        <div class="roulette-title">🎲 先攻決定！</div>
        <div class="roulette-wheel" id="roulette-wheel">
            <div class="roulette-player blue" data-player="blue">
                <span>⚡</span>
                <span class="roulette-player-name">P1</span>
            </div>
            <div class="roulette-player yellow" data-player="yellow">
                <span>⭐</span>
                <span class="roulette-player-name">P2</span>
            </div>
            <div class="roulette-player red" data-player="red">
                <span>🔥</span>
                <span class="roulette-player-name">P3</span>
            </div>
            <div class="roulette-player green" data-player="green">
                <span>🍀</span>
                <span class="roulette-player-name">P4</span>
            </div>
        </div>
        <div class="roulette-result" id="roulette-result">先攻が決まりました！</div>
        <div class="roulette-order" id="roulette-order">順番: P1 → P2 → P3 → P4</div>
    </div>

    <!-- スタート画面 -->
    <div class="overlay" id="start-overlay">
        <div class="start-wrapper">
            <div class="start-left">
                <div class="start-title">LEVER MASTER</div>
                <div class="start-subtitle">てこマスター</div>
                <div class="learning-badge">📚 小6理科「てこ」</div>

                <!-- サウンドトグルボタン -->
                <button type="button" class="start-sound-btn" id="start-sound-btn" onclick="toggleStartSound()">
                    <span class="sound-icon" id="start-sound-icon">🔇</span>
                    <span class="sound-label" id="start-sound-label">BGM OFF</span>
                </button>

                <div class="mode-select">
                    <button type="button" class="mode-btn mode1" onclick="startGame('cpu1')">
                        <span class="mode-icon">🤖</span>
                        <span class="mode-label">1人</span>
                        <span class="mode-desc">vs CPU×3</span>
                    </button>
                    <button type="button" class="mode-btn mode2" onclick="startGame('pvp2')">
                        <span class="mode-icon">⚔️</span>
                        <span class="mode-label">2人</span>
                        <span class="mode-desc">vs CPU×2</span>
                    </button>
                    <button type="button" class="mode-btn mode3" onclick="startGame('pvp3')">
                        <span class="mode-icon">👥</span>
                        <span class="mode-label">3人</span>
                        <span class="mode-desc">vs CPU×1</span>
                    </button>
                    <button type="button" class="mode-btn mode4" onclick="startGame('pvp4')">
                        <span class="mode-icon">🎮</span>
                        <span class="mode-label">4人</span>
                        <span class="mode-desc">全員対戦</span>
                    </button>
                </div>

                <!-- インストールガイド（iOS/Android対応） -->
                <div class="install-guide" id="install-guide">
                    <div class="install-icon">📲</div>
                    <div class="install-text" id="install-text"></div>
                    <button type="button" class="install-close" onclick="closeInstallGuide()" aria-label="Close">✕</button>
                </div>
            </div>

            <div class="rules-box">
                <h4>📋 ルール</h4>
                <ul>
                    <li><span class="hl">つるす</span> → <span class="hl">動かす</span>(任意) → <span class="hl">傾いたらOUT!</span>
                    </li>
                </ul>
                <div class="rules-section">
                    <h5>⚖️ つり合い</h5>
                    <ul>
                        <li>働き ＝ <span class="hl">きょり × 重さ</span></li>
                        <li><span class="hl">左</span> ＝ <span class="hl">右</span> でバランス</li>
                    </ul>
                </div>
                <div class="rules-section">
                    <h5>🚫 制限</h5>
                    <ul>
                        <li><span class="red">隣はNG</span>（-1⇔+1も）</li>
                        <li><span class="red">今つるした場所×</span></li>
                        <li>1箇所に<span class="yellow">最大6個</span>まで</li>
                    </ul>
                </div>
                <div class="rules-section">
                    <h5>🏆 勝利条件</h5>
                    <ul>
                        <li>他が全員OUT or 生存時<span class="yellow">ポイント1位</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 結果画面 -->
    <div class="overlay hidden" id="result-overlay">
        <div class="result-container">
            <div class="result-icon" id="result-icon">🏆</div>
            <div class="result-title win" id="result-title">VICTORY!</div>
            <div class="result-detail" id="result-detail"></div>
            <button type="button" class="result-btn" onclick="backToStart()">RETRY</button>
        </div>
    </div>

    <!-- ルールモーダル -->
    <div class="help-modal hidden" id="help-modal">
        <div class="help-content">
            <div class="help-title">📖 くわしいルール</div>
            <div class="help-section">
                <h5>🎮 ターンの流れ</h5>
                <p>① つるす（必須）：ストックから配置<br>
                    ② うごかす（任意）：おもりを移動<br>
                    ③ はんてい：つり合いチェック→傾いたら脱落！</p>
            </div>
            <div class="help-section">
                <h5>🎯 得点計算（全員生存時）</h5>
                <p>得点＝支点からのきょり × おもりの数 × 10<br>
                    外側はハイリスク・ハイリターン！</p>
            </div>
            <div class="help-section">
                <h5>🔗 つながり移動</h5>
                <p>つかんだおもりとその下のおもり全部が一緒に動く！<br>
                    例：3個積みの真ん中をつかむ→計2個が移動</p>
            </div>
            <div class="help-section">
                <h5>🚫 制限</h5>
                <p>・隣のマスには移動できない（-1⇔+1も隣）<br>
                    ・今吊るした位置からは動かせない<br>
                    ・1箇所に最大6個まで（×マークで表示）</p>
            </div>
            <button type="button" class="help-close" onclick="closeHelp()">閉じる</button>
        </div>
    </div>

    <!-- 終了確認モーダル -->
    <div class="help-modal hidden" id="exit-modal">
        <div class="help-content" style="text-align:center;">
            <div class="help-title">🚪 ゲーム終了？</div>
            <div class="help-section">
                <p style="margin-bottom:20px;">タイトルに戻る？</p>
                <div style="display:flex;gap:12px;justify-content:center;">
                    <button type="button" class="result-btn"
                        style="padding:12px 24px;background:var(--neon-red);border-color:var(--neon-red);color:#fff;"
                        onclick="exitGame()">EXIT</button>
                    <button type="button" class="help-close" style="margin:0;padding:12px 24px;"
                        onclick="closeExitModal()">BACK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 学習モーダル -->
    <div class="learn-modal hidden" id="learn-modal">
        <div class="learn-content">
            <div class="learn-title">📚 てこのつり合いを学ぼう</div>

            <div class="learn-section">
                <h5>🔬 てこの3つの点</h5>
                <div class="diagram">
                    <div class="diagram-item">
                        <div class="icon">📍</div>
                        <div class="label">支点</div>
                        <div class="desc">てこを支える点</div>
                    </div>
                    <div class="diagram-item">
                        <div class="icon">✋</div>
                        <div class="label">力点</div>
                        <div class="desc">力を加える点</div>
                    </div>
                    <div class="diagram-item">
                        <div class="icon">📦</div>
                        <div class="label">作用点</div>
                        <div class="desc">力が働く点</div>
                    </div>
                </div>
            </div>

            <div class="learn-section">
                <h5>⚖️ てこがつり合うとき</h5>
                <p>てこがつり合うとき、左右で「てこをかたむけるはたらき」が等しくなります：</p>
                <div class="big-formula">
                    <div class="main">左うで×おもり = 右うで×おもり</div>
                    <div class="sub">（支点からのきょり × おもりの重さ）</div>
                </div>
                <p>例：<br>
                    左うで：きょり3に20gのおもり → 3×20 = 60<br>
                    右うで：きょり2に30gのおもり → 2×30 = 60<br>
                    → 60＝60で、つり合う！</p>
            </div>

            <div class="learn-section">
                <h5>🔧 身の回りのてこ</h5>
                <p>てこの原理は日常生活のいろんな道具に使われています：</p>
                <div class="examples">
                    <span class="example-item">✂️ はさみ</span>
                    <span class="example-item">🔨 くぎ抜き</span>
                    <span class="example-item">🥢 ピンセット</span>
                    <span class="example-item">🔧 ペンチ</span>
                    <span class="example-item">📎 ホチキス</span>
                    <span class="example-item">🧹 ほうき</span>
                </div>
            </div>

            <div class="learn-section">
                <h5>🎯 学習のめあて</h5>
                <p>・てこがつり合う条件を理解する<br>
                    ・「てこをかたむけるはたらき」を計算できる<br>
                    ・身の回りのてこの例を見つけられる</p>
            </div>

            <button type="button" class="help-close" onclick="closeLearn()">閉じる</button>
        </div>
    </div>

    <!-- ヘッダー -->
    <div class="header">
        <div class="game-title">LEVER MASTER</div>
        <div class="header-icons">
            <button type="button" class="header-icon sound" id="sound-btn" onclick="toggleSound()" title="Sound"
                aria-label="Toggle sound">🔊</button>
            <button type="button" class="header-icon learn" onclick="openLearn()" title="Learn"
                aria-label="Learning guide">📚</button>
            <button type="button" class="header-icon help" onclick="openHelp()" title="Rules"
                aria-label="Game rules">❓</button>
            <button type="button" class="header-icon exit" id="exit-btn" onclick="confirmExit()" title="Exit"
                aria-label="Exit game">🚪</button>
        </div>
    </div>

    <!-- プレイヤーパネル: 横並び -->
    <div class="players-row">
        <div class="player-panel blue active" id="panel-blue">
            <span class="p-icon">⚡</span>
            <span class="p-name" id="name-blue">YOU</span>
            <span class="p-stock"><span class="dot blue"></span><span id="stock-blue">0</span></span>
            <span class="p-pts"><span id="points-blue">0</span>pt</span>
        </div>
        <div class="player-panel yellow" id="panel-yellow">
            <span class="p-icon">⭐</span>
            <span class="p-name" id="name-yellow">CPU</span>
            <span class="p-stock"><span class="dot yellow"></span><span id="stock-yellow">0</span></span>
            <span class="p-pts"><span id="points-yellow">0</span>pt</span>
        </div>
        <div class="player-panel red" id="panel-red">
            <span class="p-icon">🔥</span>
            <span class="p-name" id="name-red">CPU</span>
            <span class="p-stock"><span class="dot red"></span><span id="stock-red">0</span></span>
            <span class="p-pts"><span id="points-red">0</span>pt</span>
        </div>
        <div class="player-panel green" id="panel-green">
            <span class="p-icon">🍀</span>
            <span class="p-name" id="name-green">CPU</span>
            <span class="p-stock"><span class="dot green"></span><span id="stock-green">0</span></span>
            <span class="p-pts"><span id="points-green">0</span>pt</span>
        </div>
    </div>

    <canvas id="game-canvas"></canvas>

    <div class="game-hint" id="game-hint" role="status" aria-live="polite">
        <button type="button" class="hint-close" onclick="hideHint()" aria-label="Close hint">✕</button>
        <div class="hint-text" id="hint-text">ドラッグして置こう！</div>
        <div class="hint-sub" id="hint-sub">光っている場所へ</div>
    </div>

    <div class="bottom-panel">
        <div class="game-bar">
            <span class="moment-group">
                <span class="moment-label">L</span>
                <span class="moment left" id="m-left">30</span>
            </span>
            <span class="balance-icon balanced" id="balance-icon">⚖️</span>
            <span class="moment-group">
                <span class="moment right" id="m-right">30</span>
                <span class="moment-label">R</span>
            </span>
            <span class="divider">│</span>
            <span class="phase-badge hang" id="phase-badge" role="status" aria-live="assertive">🎯 HANG</span>
            <button type="button" class="action-btn hidden" id="btn-redo" onclick="redoHang()"
                aria-label="Redo placement">🔄</button>
            <button type="button" class="action-btn hidden" id="btn-pass" onclick="passMove()"
                aria-label="Skip turn">SKIP</button>
        </div>
    </div>

    <!-- App Script -->
    <script src="src/js/main.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.warn('SW registration failed:', err));
            });
        }
    </script>
</body>

</html>